%% Лабораторная работа №4: Цепи Маркова и СМО
clc; clear; close all;

%% Пункт 1: Создание матрицы переходов P
P = [1 0.1 0 0;
     0.1 1 0.1 0;
     0 0.1 1 0;
     0 0 0.2 1];
states = {'Healthy','Unwell','Sick','Very sick'};

%% Пункт 2: Создаем цепь Маркова
MC = dtmc(P, 'StateNames', states);

%% Пункт 3: Вывод матрицы переходов и проверка сумм строк
disp('Пункт 3: Матрица переходов MC:'); disp(MC.P);
disp('Сумма строк матрицы:'); disp(sum(MC.P,2));

%% Пункт 4: Построение графа цепи Маркова
figure; graphplot(MC,'ColorEdges',true); title('Пункт 4: Граф цепи Маркова');

%% Пункт 5: Кумулятивная матрица переходов
P_cum = cumsum(MC.P,2);

%% Пункт 6: Моделирование цепи Маркова (200 итераций)
T = 200; z = zeros(T,1); z(1)=1;
for t=1:T-1
    r=rand;
    z(t+1) = find(r<=P_cum(z(t),:),1);
end

%% Пункт 7: График изменения состояния цепи (200 итераций)
figure; plot(z,'o-'); title('Пункт 7: Состояния цепи (200 ит.)'); xlabel('t'); ylabel('Состояние');

%% Пункт 8: Моделирование цепи для 1000 и 10000 итераций и оценка матрицы переходов
for N=[1000 10000]
    z = zeros(N,1); z(1)=1;
    for t=1:N-1
        r=rand; z(t+1)=find(r<=P_cum(z(t),:),1);
    end
    
    % Пункт 9: Расчет оценки матрицы переходов по наблюдениям
    P_obs = zeros(4,4);
    for t=1:N-1
        P_obs(z(t),z(t+1)) = P_obs(z(t),z(t+1)) +1;
    end
    P_obs = P_obs ./ sum(P_obs,2);  % нормализация
    
    figure; 
    graphplot(dtmc(P_obs, 'StateNames', states),'ColorEdges',true);
    title(['Пункт 9: Граф цепи Маркова (',num2str(N),' ит.)']);
end

%% Пункт 10: Сравнение результатов пунктов 4 и 9
% Сравнение графически видно из построенных графов.
% Выводы делаются в пункте графики.

%% Пункт 11: Повтор моделирования для цепи 200 наблюдений
z = zeros(200,1); z(1)=1;
for t=1:199
    r=rand; z(t+1)=find(r<=P_cum(z(t),:),1);
end
figure; plot(z,'o-'); title('Пункт 11: Повтор графика цепи (200 ит.)');

%% Пункт 12: Система массового обслуживания
lambda=50; mu=10; n=10; m=10;
rho=lambda/mu;

% Вероятность 0-занятых
p0 = 1 / (sum(rho.^(0:n)/factorial(0:n)) + (rho^(n+1)*(1-rho^m))/(factorial(n)*(1-rho)));

% Показатели эффективности
P_otk = (rho^(n+m)/factorial(n)) * p0; % Вероятность отказа
Q = 1 - P_otk;                         % Относительная пропускная способность
A = lambda * Q;                         % Абсолютная пропускная способность
k_zan = rho * Q;                        % Среднее число занятых каналов
L_och = (rho^(n+1)/factorial(n))*(1-(rho/n)^m)*(1-(rho/n)*m)/( (1-(rho/n))^2 )*p0; % Среднее число в очереди
T_och = L_och / lambda;                 % Среднее время ожидания
L_sist = L_och + k_zan;                 % Среднее число заявок в системе
T_sist = L_sist / lambda;               % Среднее время пребывания

% Вывод таблицы показателей эффективности
T = table(P_otk,Q,A,k_zan,L_och,T_och,L_sist,T_sist);
disp('Пункт 12: Показатели эффективности СМО:'); disp(T);
